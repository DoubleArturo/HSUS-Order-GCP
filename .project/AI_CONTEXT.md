# HSUS Project AI Context

This document is the **Single Source of Truth** for AI assistants working on the HSUS Order Status project. All code generation and refactoring must strictly adhere to these standards.

## 1. Golden Standards ðŸ†

Based on the verified **BOL Entry Tool** (`src/services/BolService.ts`), the following patterns are the Project Standard:

### Service Layer (`src/services/`)
*   **Pattern**: Use **Classes** with `static async` methods.
*   **Responsibility**: Encapsulate all business logic and database orchestration.
*   **Transactions**:
    *   **MUST** use `BEGIN`...`COMMIT`/`ROLLBACK` for any write operation affecting multiple tables.
    *   **MUST** use `pool.connect()` to get a dedicated client for transactions.
    *   **MUST** use `try/catch/finally` to ensure `client.release()`.
*   **Example**:
    ```typescript
    export class BolService {
        static async saveBolData(data: BolPayload) {
            const client = await pool.connect();
            try {
                await client.query('BEGIN');
                // ... operations ...
                await client.query('COMMIT');
            } catch (e) {
                await client.query('ROLLBACK');
                throw e;
            } finally {
                client.release();
            }
        }
    }
    ```

### Repository Layer (`src/repositories/`)
*   **Pattern**: Functional exports (e.g., `findByOrderNumber`). 
*   **Note**: While `BolService` implemented direct SQL for speed, **Core Domain Entities** (Orders, Shipments) should ideally utilize `src/repositories/` to avoid query duplication.
*   **SQL Rule**: **Native SQL** with Parameterized Queries (`$1, $2`) is Mandatory. No ORMs.

### Controller Layer (`src/controllers/`)
*   **Pattern**: Functional Express handlers.
*   **Restriction**: **NO** SQL allowed. **NO** Business Logic allowed.
*   **Response**: MUST use `src/utils/responses.ts` (`ok`, `created`).

### Database Infrastructure
*   **Config**: `src/config/db.ts` is the **ONLY** source of the DB pool.
*   **Type Safety**: All Query results **MUST** be typed using interfaces from `src/types/database.ts`.

## 2. Boundary Rules ðŸš§

| Layer | âœ… Allowed | âŒ Strictly Prohibited |
| :--- | :--- | :--- |
| **Controller** | Input Validation, `req.params`, `res.json`, `next(err)` | SQL Queries, complex logic, direct DB access |
| **Service** | `pool.query`, Transactions, Business Logic, `AppError` | `req`, `res`, `next` (Express objects) |
| **Repository** | `pool.query`, SQL Generation, Data Mapping | Business Logic, HTTP Handling |

## 3. Data & Migration Standards

### Database Migrations
*   **Location**: `db/migrations/`
*   **Naming**: `{Sequence}_{Description}.sql` (e.g., `001_init.sql`)
*   **Execution**: Currently manual. (Backlog item: Automate via generic script).
*   **Idempotency**: Scripts should ideally be safe to re-run or checked manually.

### TypeScript Types
*   **DB Interfaces**: Defined in `src/types/database.ts`.
*   **Naming**: PascalCase (e.g., `Order`, `Shipment`).
*   **Mapping**: Database `snake_case` columns generally mapped to `snake_case` in interfaces unless a Mapper is used.
    *   *Note: `BolService` mapped `tracking_number` -> `bolNumber` for API compatibility. This Transformation belongs in the Service.*

## 4. Workflows

### Migration Workflow (GAS -> GCP)
1.  **Analyze**: Read GAS code logic.
2.  **Plan**: Create `docs/plans/{N}_{Tool}_Migration.md`.
3.  **Service**: Implement logic in `src/services/{Tool}Service.ts` matching the Golden Standard.
4.  **Test**: Create `src/scripts/{N}_Test_{Tool}Service.ts`.
5.  **Verify**: Run Test Script -> Confirm DB State.

---
*Generated by Antigravity Framework - 2026-01-08*
